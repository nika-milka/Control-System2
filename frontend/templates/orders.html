{% extends "base.html" %}

{% block content %}
<h2>Заказы</h2>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% if user.role in ['engineer', 'manager', 'admin'] %}
<div class="mb-3">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createOrderModal">
        Создать заказ
    </button>
</div>
{% endif %}

<!-- Фильтры -->
<div class="card mb-3">
    <div class="card-body">
        <form method="GET" class="row g-2">
            <div class="col-md-3">
                <label class="form-label">Статус</label>
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">Все статусы</option>
                    <option value="created" {% if status_filter == 'created' %}selected{% endif %}>Создан</option>
                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>В работе</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Выполнен</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Отменен</option>
                </select>
            </div>
        </form>
    </div>
</div>

{% if orders %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Название</th>
                <th>Описание</th>
                <th>Статус</th>
                <th>Сумма</th>
                <th>Кол-во позиций</th>
                <th>Дата создания</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>
                    <a href="{{ url_for('order_detail', order_id=order.id) }}" class="text-decoration-none">
                        {{ order.title }}
                    </a>
                </td>
                <td>{{ order.description|truncate(50) or '-' }}</td>
                <td>
                    <span class="badge 
                        {% if order.status == 'completed' %}bg-success
                        {% elif order.status == 'in_progress' %}bg-primary
                        {% elif order.status == 'cancelled' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {% if order.status == 'created' %}создан
                        {% elif order.status == 'in_progress' %}в работе
                        {% elif order.status == 'completed' %}выполнен
                        {% elif order.status == 'cancelled' %}отменен
                        {% else %}{{ order.status }}{% endif %}
                    </span>
                </td>
                <td>{{ "%.2f"|format(order.total_amount) }} руб.</td>
                <td>
                    {% if order.items and order.items is iterable %}
                        {{ order.items|length }}
                    {% else %}
                        0
                    {% endif %}
                </td>
                <td>{{ order.created_at }}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('order_detail', order_id=order.id) }}" 
                           class="btn btn-outline-primary">Просмотр</a>
                        
                        {% if user.role in ['engineer', 'manager', 'admin'] %}
                        <a href="{{ url_for('edit_order', order_id=order.id) }}" 
                           class="btn btn-outline-warning">Редактировать</a>
                        {% endif %}
                        
                        {% if user.role in ['engineer', 'manager', 'admin'] and order.status in ['created', 'in_progress'] %}
                        <button class="btn btn-outline-info dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown" aria-expanded="false">
                            Статус
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}">
                                    <input type="hidden" name="status" value="in_progress">
                                    <button type="submit" class="dropdown-item">В работу</button>
                                </form>
                            </li>
                            <li>
                                <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}">
                                    <input type="hidden" name="status" value="completed">
                                    <button type="submit" class="dropdown-item">Выполнен</button>
                                </form>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="POST" action="{{ url_for('cancel_order', order_id=order.id) }}" 
                                      onsubmit="return confirm('Отменить этот заказ?')">
                                    <button type="submit" class="dropdown-item text-danger">Отменить</button>
                                </form>
                            </li>
                        </ul>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Пагинация -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if pagination.page == 1 %}disabled{% endif %}">
            <a class="page-link" href="?page={{ pagination.page - 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Назад</a>
        </li>
        
        {% for p in range(1, pagination.pages + 1) %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
            <a class="page-link" href="?page={{ p }}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ p }}</a>
        </li>
        {% endfor %}
        
        <li class="page-item {% if pagination.page == pagination.pages %}disabled{% endif %}">
            <a class="page-link" href="?page={{ pagination.page + 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Вперед</a>
        </li>
    </ul>
</nav>
{% endif %}

{% else %}
<div class="alert alert-info">
    <h5>Нет заказов для отображения</h5>
    <p>Создайте первый заказ или измените параметры фильтрации.</p>
</div>
{% endif %}

<!-- Модальное окно создания заказа -->
{% if user.role in ['engineer', 'manager', 'admin'] %}
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создать заказ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/create_order" id="orderForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Название заказа *</label>
                        <input type="text" class="form-control" name="title" required 
                               placeholder="Например: Заказ строительных материалов">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Описание</label>
                        <textarea class="form-control" name="description" rows="3"
                                  placeholder="Описание заказа..."></textarea>
                    </div>
                    
                    <h6>Позиции заказа</h6>
                    <div id="itemsContainer">
                        <div class="item-row row g-2 mb-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control item-product" name="item_product_1" 
                                       placeholder="Наименование товара" required>
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control item-quantity" name="item_quantity_1" 
                                       placeholder="Количество" min="1" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control item-price" name="item_price_1" 
                                       placeholder="Цена за единицу" min="0" step="0.01" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">×</button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItem()">
                        + Добавить позицию
                    </button>
                    
                    <div class="mt-3">
                        <strong>Итого: </strong><span id="totalAmount">0.00</span> руб.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Создать заказ</button>
                </div>
                <input type="hidden" name="item_count" id="itemCount" value="1">
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
let itemCounter = 1;

function addItem() {
    itemCounter++;
    const container = document.getElementById('itemsContainer');
    const newItem = document.createElement('div');
    newItem.className = 'item-row row g-2 mb-2';
    newItem.innerHTML = `
        <div class="col-md-5">
            <input type="text" class="form-control item-product" name="item_product_${itemCounter}" 
                   placeholder="Наименование товара" required>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control item-quantity" name="item_quantity_${itemCounter}" 
                   placeholder="Количество" min="1" required onchange="calculateTotal()">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control item-price" name="item_price_${itemCounter}" 
                   placeholder="Цена за единицу" min="0" step="0.01" required onchange="calculateTotal()">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">×</button>
        </div>
    `;
    container.appendChild(newItem);
    document.getElementById('itemCount').value = itemCounter;
}

function removeItem(button) {
    if (document.querySelectorAll('.item-row').length > 1) {
        button.closest('.item-row').remove();
        calculateTotal();
    }
}

function calculateTotal() {
    let total = 0;
    document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        total += quantity * price;
    });
    document.getElementById('totalAmount').textContent = total.toFixed(2);
}

// Инициализация расчета при загрузке
document.addEventListener('DOMContentLoaded', function() {
    calculateTotal();
});
</script>
{% endblock %}