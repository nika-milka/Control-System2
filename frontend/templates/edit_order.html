{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Редактирование заказа</h2>

    <form method="POST" action="{{ url_for('update_order', order_id=order.id) }}" id="orderForm">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Название заказа *</label>
                            <input type="text" class="form-control" name="title" 
                                   value="{{ order.title }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" rows="3">{{ order.description or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Статус</label>
                            <select class="form-select" name="status">
                                <option value="created" {% if order.status == 'created' %}selected{% endif %}>Создан</option>
                                <option value="in_progress" {% if order.status == 'in_progress' %}selected{% endif %}>В работе</option>
                                <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Выполнен</option>
                                <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Отменен</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Информация о заказе</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <th>ID:</th>
                                <td>{{ order.id[:8] }}...</td>
                            </tr>
                            <tr>
                                <th>Создан:</th>
                                <td>{{ order.created_at }}</td>
                            </tr>
                            <tr>
                                <th>Обновлен:</th>
                                <td>{{ order.updated_at or order.created_at }}</td>
                            </tr>
                            <tr>
                                <th>Текущая сумма:</th>
                                <td><strong>{{ "%.2f"|format(order.total_amount) }} руб.</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Позиции заказа</h5>
            </div>
            <div class="card-body">
                <div id="itemsContainer">
                    {% if order.items %}
                        {% for item in order.items %}
                        <div class="item-row row g-2 mb-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control item-product" name="item_product_{{ loop.index }}" 
                                       value="{{ item.product }}" placeholder="Наименование товара" required>
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control item-quantity" name="item_quantity_{{ loop.index }}" 
                                       value="{{ item.quantity }}" placeholder="Количество" min="1" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control item-price" name="item_price_{{ loop.index }}" 
                                       value="{{ "%.2f"|format(item.unit_price) }}" placeholder="Цена за единицу" min="0" step="0.01" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">×</button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="item-row row g-2 mb-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control item-product" name="item_product_1" 
                                       placeholder="Наименование товара" required>
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control item-quantity" name="item_quantity_1" 
                                       placeholder="Количество" min="1" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control item-price" name="item_price_1" 
                                       placeholder="Цена за единицу" min="0" step="0.01" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">×</button>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addItem()">
                    + Добавить позицию
                </button>
                
                <div class="mt-3">
                    <strong>Итого: </strong><span id="totalAmount">{{ "%.2f"|format(order.total_amount) }}</span> руб.
                </div>
            </div>
        </div>

        <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary">Сохранить изменения</button>
            <a href="{{ url_for('order_detail', order_id=order.id) }}" class="btn btn-secondary">Отмена</a>
            <a href="{{ url_for('orders_page') }}" class="btn btn-outline-secondary">Назад к списку</a>
        </div>
        
        <input type="hidden" name="item_count" id="itemCount" value="{{ order.items|length if order.items else 1 }}">
    </form>
</div>

<script>
let itemCounter = {{ order.items|length if order.items else 1 }};

function addItem() {
    itemCounter++;
    const container = document.getElementById('itemsContainer');
    const newItem = document.createElement('div');
    newItem.className = 'item-row row g-2 mb-2';
    newItem.innerHTML = `
        <div class="col-md-5">
            <input type="text" class="form-control item-product" name="item_product_${itemCounter}" 
                   placeholder="Наименование товара" required>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control item-quantity" name="item_quantity_${itemCounter}" 
                   placeholder="Количество" min="1" required onchange="calculateTotal()">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control item-price" name="item_price_${itemCounter}" 
                   placeholder="Цена за единицу" min="0" step="0.01" required onchange="calculateTotal()">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">×</button>
        </div>
    `;
    container.appendChild(newItem);
    document.getElementById('itemCount').value = itemCounter;
}

function removeItem(button) {
    if (document.querySelectorAll('.item-row').length > 1) {
        button.closest('.item-row').remove();
        calculateTotal();
        updateItemNames();
    }
}

function updateItemNames() {
    const items = document.querySelectorAll('.item-row');
    items.forEach((item, index) => {
        const productInput = item.querySelector('.item-product');
        const quantityInput = item.querySelector('.item-quantity');
        const priceInput = item.querySelector('.item-price');
        
        productInput.name = `item_product_${index + 1}`;
        quantityInput.name = `item_quantity_${index + 1}`;
        priceInput.name = `item_price_${index + 1}`;
    });
    document.getElementById('itemCount').value = items.length;
}

function calculateTotal() {
    let total = 0;
    document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        total += quantity * price;
    });
    document.getElementById('totalAmount').textContent = total.toFixed(2);
}

// Инициализация расчета при загрузке
document.addEventListener('DOMContentLoaded', function() {
    calculateTotal();
});

// Валидация формы
document.getElementById('orderForm').addEventListener('submit', function(e) {
    const title = document.querySelector('input[name="title"]').value.trim();
    if (!title) {
        e.preventDefault();
        alert('Пожалуйста, заполните название заказа');
        return false;
    }
    
    let hasItems = false;
    document.querySelectorAll('.item-row').forEach(row => {
        const product = row.querySelector('.item-product').value.trim();
        const quantity = row.querySelector('.item-quantity').value;
        const price = row.querySelector('.item-price').value;
        
        if (product && quantity && price) {
            hasItems = true;
        }
    });
    
    if (!hasItems) {
        e.preventDefault();
        alert('Пожалуйста, добавьте хотя бы одну позицию в заказ');
        return false;
    }
});
</script>
{% endblock %}